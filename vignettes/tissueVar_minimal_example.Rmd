---
title: "Minimal tissue variation comparion example"
author: "Alice Balard"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Minimal tissue variation comparion example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(
eval = TRUE,
message = FALSE,
warning = FALSE,
echo = TRUE,
fig.align = "center",
fig.width = 12, # base width in inches
fig.height = 6,
out.width = "100%" # make the figure scale to container width
)

`%>%` <- magrittr::`%>%`
```

## 1. Create a mock methylation dataset

```{r}
mock <- hyperVarMeth::create_mock_hvCpG_data()
```

This creates a small mock dataset with a few CpGs, samples, and datasets for testing.

## 2. Prepare data

```{r}
prep <- hyperVarMeth::prepData("mock", dirname(mock$metadata))
str(prep)
```

## 3. Run the tissue variability analysis 
```{r}
res <- hyperVarMeth::runAndSave_tissueAnalysis(
  analysis = "mock",
  cpg_names_vec = prep$cpg_names_all,
  resultDir = "tmp",
  NCORES = 1,
  p1 = 0.9,
  batch_size = 20,
  dataDir = dirname(mock$metadata),
  skipsave = TRUE
)
```

## 4. Compute stats & plot for boxplot
```{r}
## Compute boxplot stats manually (useful for gigantic matrices!)

compute_box_stats_vectorized <- function(mat) {
  # Column-wise quantiles
  q1 <- matrixStats::colQuantiles(mat, probs = 0.25, na.rm = TRUE)
  med <- matrixStats::colQuantiles(mat, probs = 0.5, na.rm = TRUE)
  q3 <- matrixStats::colQuantiles(mat, probs = 0.75, na.rm = TRUE)
  
  iqr <- q3 - q1
  
  # Whiskers
  min_vals <- matrixStats::colMins(mat, na.rm = TRUE)
  max_vals <- matrixStats::colMaxs(mat, na.rm = TRUE)
  
  whisker_lower <- pmax(min_vals, q1 - 1.5*iqr)
  whisker_upper <- pmin(max_vals, q3 + 1.5*iqr)
  
  # Combine into data.frame
  data.frame(
    ymin = whisker_lower,
    lower = q1,
    middle = med,
    upper = q3,
    ymax = whisker_upper,
    dataset = colnames(mat)
  )
}

box_stats <- compute_box_stats_vectorized(res)
head(box_stats)

## reorder for plot
box_stats$dataset <- factor(box_stats$dataset, levels = box_stats$dataset)

## Plot
ggplot2::ggplot(box_stats, ggplot2::aes(x = dataset, 
                      ymin = ymin, 
                      lower = lower, 
                      middle = middle, 
                      upper = upper, 
                      ymax = ymax)) +
  ggplot2::geom_boxplot(stat = "identity", fill = "skyblue", color = "black") +
  ggplot2::theme_minimal(base_size = 14) +
  ggplot2::labs(title = "Manual Boxplot per Dataset", y = "Value", x = "Dataset")
```

## 5. Compute & plot density for each dataset
```{r}
# Reshape only these three columns
plot_df <- res %>% as.data.frame() %>%
  tidyr::pivot_longer(everything(), names_to = "dataset", values_to = "value")

## reorder for plot
plot_df$dataset <- factor(plot_df$dataset, levels = unique(plot_df$dataset))

# Combine histograms
# ggplot2::ggplot(plot_df, ggplot2::aes(x = value, group = dataset, fill = dataset)) +
#   # ggplot2::geom_density(bins = 50, alpha = .4) +
#   ggplot2::geom_histogram(position = "dodge") +
#   ggplot2::theme_minimal(base_size = 14) +
#   ggplot2::scale_fill_viridis_d() +
#   ggplot2::xlab("log posterior probability that the CpG is hypervariable in dataset k")


ggplot2::ggplot(plot_df, ggplot2::aes(x = value, group = dataset, fill = dataset)) +
  ggplot2::geom_histogram(position = "dodge") +
  ggplot2::facet_wrap(.~dataset, ncol = 3) +
  ggplot2::theme_minimal(base_size = 14) +
  ggplot2::theme(legend.position = "none") +
  ggplot2::scale_fill_viridis_d() +
  ggplot2::xlab("log posterior probability that the CpG is hypervariable in dataset k")

```

